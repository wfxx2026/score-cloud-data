<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨å‘˜ç­”é¢˜åˆ†æ•°äº‘ç«¯ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ SheetJS åº“ç”¨äºå¯¼å‡º Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .exceed-limit {
            background: linear-gradient(135deg, #ff4757 0%, #ff6348 100%) !important;
            color: white !important;
            font-weight: bold;
            animation: pulse-red 2s infinite;
        }
        
        @keyframes pulse-red {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .sticky-col {
            position: sticky;
            left: 0;
            background: rgba(255, 255, 255, 0.98);
            z-index: 20;
            backdrop-filter: blur(10px);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* æœˆåº¦æ±‡æ€»æŒ‰é’®æ ·å¼ */
        .monthly-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }
        
        .monthly-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 p-3 md:p-6">
    <div class="max-w-7xl mx-auto space-y-3">
        
        <!-- å¤´éƒ¨ -->
        <div class="glass-effect rounded-xl shadow-lg p-4 fade-in">
            <div class="flex flex-col md:flex-row justify-between items-center gap-3">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        ğŸ“Š å…¨å‘˜ç­”é¢˜åˆ†æ•°äº‘ç«¯æŸ¥çœ‹
                    </h1>
                    <p class="text-gray-600 text-sm mt-1">åå°ä¸Šä¼  Â· æ•°æ®æ–‡ä»¶å­˜å‚¨ Â· å®æ—¶å¯è§†åŒ–</p>
                </div>
                <div class="flex gap-2 items-center">
                    <select id="monthSelect" class="px-3 py-2 text-sm border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                    </select>
                    <button onclick="loadData()" class="px-4 py-2 text-sm bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition transform hover:scale-105 flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        åˆ·æ–°
                    </button>
                    <a href="./monthly-reports/" class="monthly-btn px-4 py-2 text-sm text-white rounded-lg flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        æœˆåº¦æ±‡æ€»
                    </a>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡å¡ç‰‡ + åˆ†æ•°åˆ†å¸ƒ åˆå¹¶è¡Œ -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-3 fade-in" style="animation-delay: 0.1s">
            <!-- å·¦ä¾§ç»Ÿè®¡å¡ç‰‡ -->
            <div class="lg:col-span-1 grid grid-cols-2 lg:grid-cols-1 gap-2">
                <div class="glass-effect rounded-lg p-3 shadow hover:shadow-md transition">
                    <div class="text-xl font-bold text-blue-600" id="stat-total">-</div>
                    <div class="text-gray-500 text-xs mt-0.5">æ€»äººæ•°</div>
                </div>
                <div class="glass-effect rounded-lg p-3 shadow hover:shadow-md transition">
                    <div class="text-xl font-bold text-purple-600" id="stat-avg">-</div>
                    <div class="text-gray-500 text-xs mt-0.5">å¹³å‡åˆ†</div>
                </div>
                <div class="glass-effect rounded-lg p-3 shadow hover:shadow-md transition">
                    <div class="text-xl font-bold text-red-500" id="stat-exceed">-</div>
                    <div class="text-gray-500 text-xs mt-0.5">å¼‚å¸¸äººæ•°</div>
                </div>
                <div class="glass-effect rounded-lg p-3 shadow hover:shadow-md transition">
                    <div class="text-xl font-bold text-green-600" id="stat-max">-</div>
                    <div class="text-gray-500 text-xs mt-0.5">æœ€é«˜æ€»åˆ†</div>
                </div>
            </div>
            
            <!-- å³ä¾§åˆ†æ•°åˆ†å¸ƒå›¾è¡¨ -->
            <div class="lg:col-span-3 glass-effect rounded-lg shadow-lg p-3">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-sm text-gray-800">ğŸ“ˆ åˆ†æ•°åˆ†å¸ƒ</h3>
                    <div class="flex gap-2 text-xs">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-red-500 rounded-full"></span>å¼‚å¸¸</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full"></span>æ­£å¸¸</span>
                    </div>
                </div>
                <div id="chart-container" class="h-24 flex items-end justify-around gap-1 overflow-x-auto pb-1">
                </div>
            </div>
        </div>

        <!-- æ•°æ®è¡¨æ ¼ -->
        <div class="glass-effect rounded-xl shadow-xl overflow-hidden fade-in" style="animation-delay: 0.2s">
            <div class="p-3 border-b border-gray-200 flex justify-between items-center bg-white/50">
                <h3 class="font-bold text-base text-gray-800">ğŸ“‹ è¯¦ç»†æ•°æ®</h3>
                <div class="flex gap-2">
                    <button onclick="exportExcel()" class="px-3 py-1.5 text-xs bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        å¯¼å‡ºExcel
                    </button>
                </div>
            </div>
            <div class="overflow-auto" style="max-height: 60vh;">
                <table class="w-full text-sm" id="dataTable">
                    <thead class="bg-gray-100 sticky top-0 z-30">
                        <tr id="tableHeader">
                            <th class="sticky-col px-3 py-2 text-left font-semibold text-gray-700 text-xs">åºå·</th>
                            <th class="sticky-col px-3 py-2 text-left font-semibold text-gray-700 text-xs" style="left: 60px;">ç”¨æˆ·å</th>
                            <th class="px-3 py-2 text-center font-semibold text-blue-600 bg-blue-50 text-xs">å½“æœˆæ€»åˆ†</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="3" class="text-center py-8">
                                <div class="loading-spinner mx-auto mb-2" style="width: 32px; height: 32px; border-width: 2px;"></div>
                                <p class="text-gray-400 text-sm">åŠ è½½ä¸­...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- åˆ†æ•°è¯´æ˜ -->
        <div class="glass-effect border-l-4 border-yellow-400 rounded-lg p-4 text-xs text-gray-700 fade-in" style="animation-delay: 0.3s">
            <h4 class="font-bold mb-2 text-sm flex items-center gap-2">
                <svg class="w-4 h-4 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                åˆ†æ•°è¯´æ˜
            </h4>
            <div class="grid md:grid-cols-2 gap-2">
                <p><span class="font-medium text-blue-600">1.</span> ç­¾åˆ°è§„åˆ™ï¼šæ¯æ—¥ç­¾åˆ°1åˆ†ï¼Œè¿ç»­ç™»å½•æ¯æ—¥å¤š1åˆ†ï¼Œä¸Šé™ï¼šæ¯æ—¥æœ€å¤š3åˆ†</p>
                <p><span class="font-medium text-blue-600">2.</span> çŸ¥è¯†å­¦ä¹ è§„åˆ™ï¼šæ¯æ—¥å­¦ä¹ 1ä¸ªçŸ¥è¯†ç‚¹ç§¯1åˆ†ï¼Œä¸Šé™ï¼šæ¯æ—¥æœ€å¤š1åˆ†</p>
                <p><span class="font-medium text-blue-600">3.</span> æ¨¡æ‹Ÿè€ƒè¯•è§„åˆ™ï¼šæ¯æ—¥åŠæ ¼è®¡3åˆ†ï¼Œæ»¡åˆ†è®¡4åˆ†ï¼Œä¸Šé™ï¼šæ¯æ—¥æœ€å¤š8åˆ†</p>
                <p><span class="font-medium text-blue-600">4.</span> æ‰‹æœºè€ƒè¯•è§„åˆ™ï¼šæ¯æ—¥åŠæ ¼è®¡6åˆ†ï¼Œæ»¡åˆ†è®¡8åˆ†ï¼Œä¸Šé™ï¼šæ¯æ—¥æœ€å¤š16åˆ†</p>
                <p><span class="font-medium text-blue-600">5.</span> è§†é¢‘å­¦ä¹ è§„åˆ™ï¼šæ¯æ—¥è§†é¢‘å­¦ä¹ æ»¡5åˆ†é’Ÿç§¯1åˆ†ï¼Œä¸Šé™ï¼šæ¯æ—¥æœ€å¤š1åˆ†</p>
                <p><span class="font-medium text-blue-600">6.</span> ç»ƒä¹ æ—¶é•¿è§„åˆ™ï¼šæ¯æ—¥ç»ƒä¹ æœ‰æ•ˆæ—¶é•¿è¶…è¿‡2å°æ—¶åŠ 10åˆ†ï¼Œä¸Šé™ï¼šæ¯æ—¥æœ€å¤š10åˆ†</p>
                <p><span class="font-medium text-blue-600">7.</span> æ‰‹æœºç»ƒä¹ è§„åˆ™ï¼šæ¯æ—¥æ¯ç»ƒä¹ 50é¢˜åŠ 1åˆ†ï¼Œä¸Šé™ï¼šæ¯æ—¥æœ€å¤š6åˆ†</p>
            </div>
            <div class="mt-3 p-2 bg-yellow-100 rounded text-center font-medium text-xs">
                æ­£å¸¸åˆ†æ•°ï¼š45åˆ†ã€35åˆ†ã€165åˆ†ã€175åˆ† âœ… | å…¶ä½™åˆ†æ•°å‡ä¸ºå¼‚å¸¸ âš ï¸
            </div>
        </div>

        <!-- é¡µè„š -->
        <div class="text-center text-gray-500 text-xs py-2 fade-in" style="animation-delay: 0.4s">
            <p>æ•°æ®æ¥è‡ªå¹³å°æ¥å£ | ä»…ä¾›å­¦ä¹ å‚è€ƒ</p>
            <p class="mt-0.5">æœ€åæ›´æ–°ï¼š<span id="lastUpdate">-</span></p>
        </div>
    </div>

    <script>
        // æ­£å¸¸åˆ†æ•°ç™½åå•ï¼Œä¸åœ¨æ­¤åˆ—è¡¨ä¸­çš„éƒ½æ˜¯å¼‚å¸¸åˆ†æ•°
        const NORMAL_SCORES = [45, 35, 165, 175];
        let currentData = null;
        let currentMonth = '';

        function generateMonthOptions() {
            const select = document.getElementById('monthSelect');
            const now = new Date();
            
            for (let i = 0; i < 12; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                const label = i === 0 ? 'æœ¬æœˆ' : i === 1 ? 'ä¸Šä¸ªæœˆ' : `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ`;
                
                const option = document.createElement('option');
                option.value = value;
                option.textContent = label;
                if (i === 0) option.selected = true;
                select.appendChild(option);
            }
            
            currentMonth = select.value;
            select.addEventListener('change', (e) => {
                currentMonth = e.target.value;
                loadData();
            });
        }

        async function loadData() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center py-8">
                        <div class="loading-spinner mx-auto mb-2" style="width: 32px; height: 32px; border-width: 2px;"></div>
                        <p class="text-gray-400 text-sm">åŠ è½½ä¸­...</p>
                    </td>
                </tr>
            `;
            
            try {
                const response = await fetch(`./data/${currentMonth}.json?t=${Date.now()}`);
                if (!response.ok) throw new Error('æš‚æ— æ•°æ®');
                
                const data = await response.json();
                currentData = data;
                renderData(data);
                updateLastUpdate();
            } catch (e) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="100" class="text-center py-8 text-gray-400">
                            <div class="mb-2 text-4xl">ğŸ“­</div>
                            <p class="text-sm">æš‚æ— æ•°æ®</p>
                            <p class="text-xs mt-1">è¯·ç¡®ä¿æ•°æ®æ–‡ä»¶å·²ä¸Šä¼ åˆ° data/${currentMonth}.json</p>
                        </td>
                    </tr>
                `;
                updateStats([]);
                document.getElementById('chart-container').innerHTML = '<div class="text-gray-400 w-full text-center text-sm">æš‚æ— æ•°æ®</div>';
            }
        }

        function renderData(data) {
            const users = Object.values(data).filter(u => u.userName);
            updateStats(users);
            renderChart(users);
            renderTable(users);
        }

        function updateStats(users) {
            const total = users.length;
            const avg = total > 0 ? Math.round(users.reduce((sum, u) => sum + (u.monthlyTotal || 0), 0) / total) : 0;
            // å¼‚å¸¸äººæ•°ï¼šæœ‰ä»»æ„ä¸€å¤©åˆ†æ•°ä¸åœ¨ç™½åå•ä¸­
            const exceed = users.filter(u => Object.values(u.dailyScores || {}).some(s => !NORMAL_SCORES.includes(s))).length;
            const max = total > 0 ? Math.max(...users.map(u => u.monthlyTotal || 0)) : 0;

            animateNumber('stat-total', total);
            animateNumber('stat-avg', avg);
            animateNumber('stat-exceed', exceed);
            animateNumber('stat-max', max);
        }

        function animateNumber(id, target) {
            const el = document.getElementById(id);
            const start = parseInt(el.textContent) || 0;
            const duration = 500;
            const startTime = performance.now();

            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 3);
                const current = Math.round(start + (target - start) * easeProgress);
                
                el.textContent = current;
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            requestAnimationFrame(update);
        }

        function renderChart(users) {
            const container = document.getElementById('chart-container');
            if (users.length === 0) {
                container.innerHTML = '<div class="text-gray-400 w-full text-center text-sm">æš‚æ— æ•°æ®</div>';
                return;
            }

            const sorted = [...users].sort((a, b) => (b.monthlyTotal || 0) - (a.monthlyTotal || 0)).slice(0, 15);
            const maxScore = Math.max(...sorted.map(u => u.monthlyTotal || 0), 1);

            container.innerHTML = sorted.map(user => {
                const score = user.monthlyTotal || 0;
                // æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸åˆ†æ•°ï¼ˆä¸åœ¨ç™½åå•ä¸­ï¼‰
                const hasExceed = Object.values(user.dailyScores || {}).some(s => !NORMAL_SCORES.includes(s));
                const height = maxScore > 0 ? (score / maxScore * 100) : 0;
                
                return `
                    <div class="flex flex-col items-center gap-0.5 min-w-[24px]">
                        <div class="text-[8px] text-gray-500 truncate w-full text-center" title="${user.userName}">
                            ${user.userName.substring(0, 2)}
                        </div>
                        <div class="w-4 rounded-t-sm transition-all duration-500 hover:opacity-80 relative group cursor-pointer ${hasExceed ? 'exceed-limit' : 'bg-gradient-to-t from-blue-500 to-purple-500'}" 
                             style="height: ${Math.max(height, 2)}%">
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-1 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap z-10">
                                ${user.userName}: ${score}åˆ†
                            </div>
                        </div>
                        <div class="text-[8px] font-medium ${hasExceed ? 'text-red-500' : 'text-gray-600'}">${score}</div>
                    </div>
                `;
            }).join('');
        }

        function renderTable(users) {
            const dateSet = new Set();
            users.forEach(u => Object.keys(u.dailyScores || {}).forEach(d => dateSet.add(d)));
            const dates = Array.from(dateSet).sort();

            const header = document.getElementById('tableHeader');
            header.innerHTML = `
                <th class="sticky-col px-3 py-2 text-left font-semibold text-gray-700 bg-gray-100 text-xs">åºå·</th>
                <th class="sticky-col px-3 py-2 text-left font-semibold text-gray-700 bg-gray-100 text-xs" style="left: 60px;">ç”¨æˆ·å</th>
                <th class="px-3 py-2 text-center font-semibold text-blue-600 bg-blue-50 text-xs">å½“æœˆæ€»åˆ†</th>
                ${dates.map(d => {
                    const day = new Date(d).getDate();
                    const weekday = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'][new Date(d).getDay()];
                    return `<th class="px-2 py-2 text-center text-xs text-gray-500 bg-gray-50 min-w-[40px]">
                        <div>${day}æ—¥</div>
                        <div class="text-gray-400 scale-75">å‘¨${weekday}</div>
                    </th>`;
                }).join('')}
            `;

            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = users.map((user, idx) => {
                // æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸åˆ†æ•°
                const hasExceed = Object.values(user.dailyScores || {}).some(s => !NORMAL_SCORES.includes(s));
                // è·å–å¼‚å¸¸æ—¥æœŸè¯¦æƒ…
                const exceedDays = Object.entries(user.dailyScores || {})
                    .filter(([_, s]) => !NORMAL_SCORES.includes(s))
                    .map(([d, s]) => `${d.slice(5)}(${s}åˆ†)`)
                    .join('ã€');
                
                return `
                    <tr class="hover:bg-blue-50 transition ${hasExceed ? 'bg-red-50' : ''}">
                        <td class="sticky-col px-3 py-2 font-medium text-gray-600 bg-white text-xs">${user.userIndex || idx + 1}</td>
                        <td class="sticky-col px-3 py-2 font-semibold text-gray-800 bg-white text-xs" style="left: 60px;">
                            <div class="flex items-center gap-1">
                                ${user.userName}
                                ${hasExceed ? `<span class="text-red-500 text-xs" title="å¼‚å¸¸æ—¥æœŸï¼š${exceedDays}">âš ï¸</span>` : ''}
                            </div>
                        </td>
                        <td class="px-3 py-2 text-center font-bold text-blue-600 bg-blue-50/50 text-xs">${user.monthlyTotal || 0}</td>
                        ${dates.map(date => {
                            const score = (user.dailyScores || {})[date] || 0;
                            // æ£€æŸ¥æ˜¯å¦ä¸ºå¼‚å¸¸åˆ†æ•°
                            const isExceed = !NORMAL_SCORES.includes(score);
                            return `
                                <td class="px-1 py-1">
                                    <div class="text-center py-1 rounded text-xs font-medium transition ${isExceed ? 'exceed-limit' : (score > 0 ? 'bg-gray-100 text-gray-700' : 'text-gray-300')}">
                                        ${score > 0 ? score : '-'}
                                    </div>
                                </td>
                            `;
                        }).join('')}
                    </tr>
                `;
            }).join('');
        }

        /**
         * å¯¼å‡ºExcelåŠŸèƒ½ï¼ˆä½¿ç”¨SheetJSåº“ï¼‰
         * æ”¯æŒæ ·å¼è®¾ç½®ã€è‡ªåŠ¨åˆ—å®½ã€å¼‚å¸¸åˆ†æ•°æ ‡çº¢
         */
        function exportExcel() {
            if (!currentData) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }

            const users = Object.values(currentData).filter(u => u.userName);
            if (users.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }

            // æ”¶é›†æ‰€æœ‰æ—¥æœŸ
            const dateSet = new Set();
            users.forEach(u => Object.keys(u.dailyScores || {}).forEach(d => dateSet.add(d)));
            const dates = Array.from(dateSet).sort();

            // å‡†å¤‡è¡¨å¤´
            const headers = ['åºå·', 'ç”¨æˆ·å', 'å½“æœˆæ€»åˆ†', 'å¼‚å¸¸å¤©æ•°', ...dates];
            
            // å‡†å¤‡æ•°æ®è¡Œ
            const dataRows = users.map((user, idx) => {
                // ç»Ÿè®¡å¼‚å¸¸å¤©æ•°ï¼ˆåˆ†æ•°ä¸åœ¨ç™½åå•ä¸­ï¼‰
                const exceedDays = Object.values(user.dailyScores || {}).filter(s => !NORMAL_SCORES.includes(s)).length;
                const row = [
                    user.userIndex || idx + 1,
                    user.userName,
                    user.monthlyTotal || 0,
                    exceedDays,
                    ...dates.map(d => (user.dailyScores || {})[d] || 0)
                ];
                return row;
            });

            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            
            // åˆ›å»ºå·¥ä½œè¡¨æ•°æ®ï¼ˆåŒ…å«è¡¨å¤´ï¼‰
            const wsData = [headers, ...dataRows];
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // è®¾ç½®åˆ—å®½ï¼ˆè‡ªåŠ¨é€‚åº”ï¼‰
            const colWidths = headers.map((header, idx) => {
                // è®¡ç®—è¯¥åˆ—çš„æœ€å¤§é•¿åº¦
                let maxLen = String(header).length;
                dataRows.forEach(row => {
                    const cellVal = String(row[idx] || '');
                    if (cellVal.length > maxLen) maxLen = cellVal.length;
                });
                // è®¾ç½®å®½åº¦ï¼ˆä¸­æ–‡å­—ç¬¦å 2ä¸ªå®½åº¦å•ä½ï¼Œæœ€å°å®½åº¦10ï¼‰
                return { wch: Math.max(maxLen * 1.5 + 2, 10) };
            });
            ws['!cols'] = colWidths;

            // è®¾ç½®è¡Œé«˜
            ws['!rows'] = [{ hpx: 25 }, ...dataRows.map(() => ({ hpx: 20 }))];

            // æ·»åŠ æ ·å¼ï¼ˆå¼‚å¸¸åˆ†æ•°æ ‡çº¢ï¼‰
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = 1; R <= range.e.r; ++R) { // ä»ç¬¬2è¡Œå¼€å§‹ï¼ˆè·³è¿‡è¡¨å¤´ï¼‰
                for (let C = 4; C <= range.e.c; ++C) { // ä»ç¬¬5åˆ—å¼€å§‹ï¼ˆæ—¥æœŸåˆ—ï¼‰
                    const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
                    const cell = ws[cellRef];
                    // æ£€æŸ¥æ˜¯å¦ä¸ºå¼‚å¸¸åˆ†æ•°ï¼ˆä¸åœ¨ç™½åå•ä¸­ä¸”å¤§äº0ï¼‰
                    if (cell && typeof cell.v === 'number' && cell.v > 0 && !NORMAL_SCORES.includes(cell.v)) {
                        // è®¾ç½®å­—ä½“é¢œè‰²ä¸ºçº¢è‰²
                        cell.s = {
                            font: { color: { rgb: "FF0000" }, bold: true },
                            fill: { fgColor: { rgb: "FFEEEE" } }
                        };
                    }
                }
            }

            // è®¾ç½®è¡¨å¤´æ ·å¼
            for (let C = 0; C <= range.e.c; ++C) {
                const cellRef = XLSX.utils.encode_cell({ r: 0, c: C });
                if (ws[cellRef]) {
                    ws[cellRef].s = {
                        font: { bold: true, color: { rgb: "FFFFFF" } },
                        fill: { fgColor: { rgb: "4472C4" } },
                        alignment: { horizontal: "center", vertical: "center" }
                    };
                }
            }

            // å°†å·¥ä½œè¡¨æ·»åŠ åˆ°å·¥ä½œç°¿
            XLSX.utils.book_append_sheet(wb, ws, "åˆ†æ•°æ•°æ®");

            // ç”Ÿæˆæ–‡ä»¶å
            const fileName = `åˆ†æ•°æ•°æ®_${currentMonth}.xlsx`;

            // ä½¿ç”¨ writeFile æ–¹æ³•ç›´æ¥ä¸‹è½½ï¼ˆå…¼å®¹æ€§æœ€å¥½ï¼‰
            try {
                XLSX.writeFile(wb, fileName);
            } catch (e) {
                // å¦‚æœ writeFile å¤±è´¥ï¼ˆæ—§ç‰ˆæµè§ˆå™¨ï¼‰ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                console.warn('writeFile å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨ä¸‹è½½æ–¹æ¡ˆ:', e);
                
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                
                // å…¼å®¹æ€§ä¸‹è½½æ–¹æ¡ˆ
                if (window.navigator && window.navigator.msSaveOrOpenBlob) {
                    // IE æµè§ˆå™¨
                    window.navigator.msSaveOrOpenBlob(blob, fileName);
                } else {
                    // ç°ä»£æµè§ˆå™¨
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    
                    // é’ˆå¯¹ Safari çš„ç‰¹æ®Šå¤„ç†
                    if (/iPad|iPhone|iPod/.test(navigator.userAgent)) {
                        const reader = new FileReader();
                        reader.onloadend = function() {
                            const url = reader.result;
                            window.open(url, '_blank');
                        };
                        reader.readAsDataURL(blob);
                    } else {
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                    
                    setTimeout(() => URL.revokeObjectURL(url), 1000);
                }
            }
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleString('zh-CN');
        }

        document.addEventListener('DOMContentLoaded', () => {
            generateMonthOptions();
            loadData();
        });
    </script>
</body>
</html>
