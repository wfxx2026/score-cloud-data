name: Daily Score Fetch - Hybrid

permissions:
  contents: write
  pages: write
  id-token: write
  actions: write
  issues: write

on:
  repository_dispatch:
    types: [daily-fetch, cron-fetch, manual-fetch, pages-rebuild]
  
  schedule:
    - cron: '0 16 * * *'
    - cron: '30 15 * * *'
  
  workflow_dispatch:
    inputs:
      target_date:
        description: 'æŒ‡å®šæ—¥æœŸ (YYYY-MM-DDï¼Œç•™ç©ºä¸ºä»Šå¤©)'
        required: false
        default: ''
      force_update:
        description: 'å¼ºåˆ¶æ›´æ–°ï¼ˆå³ä½¿å·²å­˜åœ¨æ•°æ®ï¼‰'
        type: boolean
        default: false
      auto_discover:
        description: 'è‡ªåŠ¨å‘çŽ°ç”¨æˆ·'
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'true'
      notify_channel:
        description: 'é€šçŸ¥æ¸ é“'
        type: choice
        options:
          - 'none'
          - 'issue'
          - 'email'
        default: 'issue'

env:
  NODE_VERSION: '20'

jobs:
  precheck:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      reason: ${{ steps.check.outputs.reason }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check if external cron already ran
        id: check
        run: |
          TODAY=$(date +%Y-%m-%d)
          SUMMARY_FILE="daily-summary/${TODAY}.json"
          
          if [ -f "$SUMMARY_FILE" ]; then
            FILE_TIME=$(stat -c %Y "$SUMMARY_FILE")
            NOW=$(date +%s)
            DIFF=$((NOW - FILE_TIME))
            
            if [ $DIFF -lt 3600 ]; then
              echo "should_run=false" >> $GITHUB_OUTPUT
              echo "reason=External cron already ran ${DIFF}s ago" >> $GITHUB_OUTPUT
              echo "â­ï¸ å¤–éƒ¨Cronå·²åœ¨1å°æ—¶å†…æ‰§è¡Œï¼Œè·³è¿‡"
              exit 0
            fi
          fi
          
          echo "should_run=true" >> $GITHUB_OUTPUT
          echo "reason=No recent data found" >> $GITHUB_OUTPUT
          echo "âœ… éœ€è¦æ‰§è¡Œæ•°æ®æŠ“å–"

  fetch:
    runs-on: ubuntu-latest
    needs: precheck
    if: |
      always() && 
      (github.event_name != 'schedule' || needs.precheck.outputs.should_run == 'true')
    
    outputs:
      fetch_count: ${{ steps.execute.outputs.fetch_count }}
      exceed_count: ${{ steps.execute.outputs.exceed_count }}
      discovered_count: ${{ steps.execute.outputs.discovered_count }}
      trigger_source: ${{ steps.info.outputs.trigger_source }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Install dependencies
        run: |
          npm ci 2>/dev/null || npm install
      
      - name: Get trigger info
        id: info
        run: |
          echo "trigger_source=${{ github.event_name }}" >> $GITHUB_OUTPUT
          echo "trigger_actor=${{ github.actor }}" >> $GITHUB_OUTPUT
          
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "trigger_source=external-cron" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "${{ github.event.inputs.target_date }}" ]; then
            echo "target_date=${{ github.event.inputs.target_date }}" >> $GITHUB_OUTPUT
          else
            echo "target_date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi
      
      - name: Execute fetch with auto-discover
        id: execute
        env:
          API_BASE_URL: ${{ secrets.API_BASE_URL }}
          API_PERSON_ID: ${{ secrets.API_PERSON_ID }}
          API_COOKIE: ${{ secrets.API_COOKIE }}
          EXTRA_USERS: ${{ secrets.EXTRA_USERS }}
          TARGET_DATE: ${{ steps.info.outputs.target_date }}
          FORCE_UPDATE: ${{ github.event.inputs.force_update }}
          AUTO_DISCOVER: ${{ github.event.inputs.auto_discover || 'true' }}
          DISCOVER_PAGE_SIZE: '500'
          MAX_DISCOVER_PAGES: '20'
          FETCH_DELAY: '800'
        run: |
          echo "========================================"
          echo "å¼€å§‹æ‰§è¡Œåˆ†æ•°æŠ“å–"
          echo "æ—¥æœŸ: ${{ steps.info.outputs.target_date }}"
          echo "è‡ªåŠ¨å‘çŽ°: ${{ github.event.inputs.auto_discover || 'true' }}"
          echo "========================================"
          
          node scripts/fetch-all.js 2>&1 | tee fetch.log
          
          # è§£æžæ—¥å¿—èŽ·å–ç»Ÿè®¡æ•°æ®
          FETCH_COUNT=$(grep -oP 'æˆåŠŸæŠ“å–: \K\d+' fetch.log || echo "0")
          EXCEED_COUNT=$(grep -oP 'è¶…é¢äººæ•°: \K\d+' fetch.log || echo "0")
          DISCOVERED_COUNT=$(grep -oP 'é€šè¿‡APIå‘çŽ° \K\d+' fetch.log || echo "0")
          TOTAL_USERS=$(grep -oP 'æœ€ç»ˆç”¨æˆ·åˆ—è¡¨: \K\d+' fetch.log || echo "0")
          
          echo "fetch_count=$FETCH_COUNT" >> $GITHUB_OUTPUT
          echo "exceed_count=$EXCEED_COUNT" >> $GITHUB_OUTPUT
          echo "discovered_count=$DISCOVERED_COUNT" >> $GITHUB_OUTPUT
          echo "total_users=$TOTAL_USERS" >> $GITHUB_OUTPUT
          
          echo "### ðŸ“Š æŠ“å–ç»“æžœæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "| æŒ‡æ ‡ | æ•°å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ç›®æ ‡æ—¥æœŸ | ${{ steps.info.outputs.target_date }} |" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘æº | ${{ steps.info.outputs.trigger_source }} |" >> $GITHUB_STEP_SUMMARY
          echo "| APIå‘çŽ°ç”¨æˆ· | $DISCOVERED_COUNT äºº |" >> $GITHUB_STEP_SUMMARY
          echo "| æœ€ç»ˆç”¨æˆ·æ€»æ•° | $TOTAL_USERS äºº |" >> $GITHUB_STEP_SUMMARY
          echo "| æˆåŠŸæŠ“å– | $FETCH_COUNT äºº |" >> $GITHUB_STEP_SUMMARY
          echo "| è¶…é¢äººæ•° | $EXCEED_COUNT äºº |" >> $GITHUB_STEP_SUMMARY
      
      - name: Generate report
        if: steps.execute.outputs.fetch_count != '0'
        run: |
          echo "ç”Ÿæˆå¯è§†åŒ–æŠ¥è¡¨..."
          node scripts/generate-report.js \
            --date ${{ steps.info.outputs.target_date }} \
            --output reports
      
      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Check for changes
        id: verify-changed-files
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â­ï¸ æ— æ•°æ®å˜æ›´"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… æ£€æµ‹åˆ°æ•°æ®å˜æ›´ï¼Œå‡†å¤‡æäº¤"
            echo ""
            echo "å˜æ›´æ–‡ä»¶åˆ—è¡¨:"
            git diff --staged --name-only
          fi
      
      - name: Commit changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "ðŸ“Š Daily update: ${{ steps.info.outputs.target_date }} [${{ steps.info.outputs.trigger_source }}]
          
          - å‘çŽ°ç”¨æˆ·: ${{ steps.execute.outputs.discovered_count }} äºº
          - æŠ“å–ç”¨æˆ·: ${{ steps.execute.outputs.fetch_count }} äºº
          - è¶…é¢äººæ•°: ${{ steps.execute.outputs.exceed_count }} äºº
          - æ‰§è¡Œæ—¶é—´: $TIMESTAMP"
      
      - name: Push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
      
      - name: Upload artifacts
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: daily-data-${{ steps.info.outputs.target_date }}
          path: |
            data/
            daily-summary/
            reports/
            discovered-users.json
          retention-days: 30
      
      - name: Trigger Pages redeploy
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.repos.createDispatchEvent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                event_type: 'pages-rebuild'
              });
              console.log('âœ… Pages é‡éƒ¨ç½²å·²è§¦å‘');
            } catch (error) {
              console.log('âš ï¸ Pages é‡éƒ¨ç½²å¤±è´¥:', error.message);
            }

  notify:
    runs-on: ubuntu-latest
    needs: [fetch]
    if: always() && needs.fetch.result != 'skipped'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Create issue on failure
        if: needs.fetch.result == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `âŒ æ•°æ®æŠ“å–å¤±è´¥ ${new Date().toISOString().split('T')[0]}`;
            const body = `## å¤±è´¥è¯¦æƒ…
            
            - è§¦å‘æº: ${{ needs.fetch.outputs.trigger_source }}
            - å·¥ä½œæµ: ${{ github.workflow }}
            - è¿è¡Œç¼–å·: ${{ github.run_id }}
            - [æŸ¥çœ‹è¯¦ç»†æ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### å¯èƒ½åŽŸå› 
            1. API Cookie è¿‡æœŸ
            2. ç½‘ç»œè¿žæŽ¥é—®é¢˜
            3. API æŽ¥å£å˜æ›´
            
            ### æ‰‹åŠ¨é‡è¯•
            [ç‚¹å‡»æ‰‹åŠ¨è§¦å‘](https://github.com/${{ github.repository }}/actions/workflows/${{ github.workflow }})`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['bug', 'automated']
            });
      
      - name: Create exceed alert
        if: |
          needs.fetch.result == 'success' && 
          needs.fetch.outputs.exceed_count != '0' &&
          needs.fetch.outputs.exceed_count != ''
        uses: actions/github-script@v7
        with:
          script: |
            const exceedCount = parseInt('${{ needs.fetch.outputs.exceed_count }}') || 0;
            if (exceedCount === 0) return;
            
            const title = `âš ï¸ ä»Šæ—¥å‘çŽ° ${exceedCount} äººåˆ†æ•°è¶…é¢`;
            const today = new Date().toISOString().split('T')[0];
            
            const fs = require('fs');
            const summaryPath = `daily-summary/${today}.json`;
            
            let body = `## è¶…é¢æé†’\n\nä»Šæ—¥æ£€æµ‹åˆ° **${exceedCount}** äººåˆ†æ•°è¶…è¿‡45åˆ†é™åˆ¶ã€‚\n\n`;
            
            try {
              const data = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
              const exceeds = Object.entries(data.users || {})
                .filter(([_, u]) => u.isExceed)
                .sort((a, b) => b[1].score - a[1].score)
                .map(([name, u]) => `- **${name}**: ${u.score}åˆ†`);
              
              body += '### è¶…é¢äººå‘˜åˆ—è¡¨\n' + exceeds.join('\n');
            } catch(e) {
              body += 'è¯¦æƒ…æŸ¥çœ‹: ' + summaryPath;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ä»Šæ—¥æé†’
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'exceed-alert',
              state: 'open'
            });
            
            const todayIssue = issues.data.find(i => i.title.includes(today));
            
            if (!todayIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `${title} - ${today}`,
                body,
                labels: ['exceed-alert', 'automated']
              });
            }
