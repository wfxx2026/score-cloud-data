name: Monthly Summary

on:
  schedule:
    # æ¯æœˆ1å·å‡Œæ™¨2ç‚¹æ‰§è¡Œï¼ˆæ±‡æ€»ä¸Šæœˆæ•°æ®ï¼‰
    - cron: '0 18 1 * *'  # UTC 18:00 = åŒ—äº¬æ—¶é—´ 02:00
  workflow_dispatch:
    inputs:
      target_month:
        description: 'ç›®æ ‡æœˆä»½ (YYYY-MMï¼Œç•™ç©ºè‡ªåŠ¨åˆ¤æ–­)'
        required: false
        default: ''
      force_regenerate:
        description: 'å¼ºåˆ¶é‡æ–°ç”Ÿæˆ'
        type: boolean
        default: false

permissions:
  contents: write
  pages: write

jobs:
  summary:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci 2>/dev/null || npm install
      
      - name: Determine target month
        id: month
        run: |
          if [ -n "${{ github.event.inputs.target_month }}" ]; then
            echo "month=${{ github.event.inputs.target_month }}" >> $GITHUB_OUTPUT
          else
            # é»˜è®¤ä¸ºä¸Šä¸ªæœˆ
            LAST_MONTH=$(date -d "last month" +%Y-%m)
            echo "month=$LAST_MONTH" >> $GITHUB_OUTPUT
          fi
          echo "æ±‡æ€»æœˆä»½: $(cat $GITHUB_OUTPUT | grep month | cut -d= -f2)"
      
      - name: Check if already exists
        id: check
        run: |
          MONTH_FILE="monthly-reports/${{ steps.month.outputs.month }}.json"
          if [ -f "$MONTH_FILE" ] && [ "${{ github.event.inputs.force_regenerate }}" != "true" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "â­ï¸ æœˆåº¦æ±‡æ€»å·²å­˜åœ¨ï¼Œè·³è¿‡"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ… éœ€è¦ç”Ÿæˆæœˆåº¦æ±‡æ€»"
          fi
      
      - name: Generate monthly summary
        if: steps.check.outputs.exists == 'false'
        id: generate
        env:
          TARGET_MONTH: ${{ steps.month.outputs.month }}
        run: |
          echo "========================================"
          echo "å¼€å§‹ç”Ÿæˆæœˆåº¦æ±‡æ€»: ${{ steps.month.outputs.month }}"
          echo "========================================"
          
          node scripts/monthly-summary.js 2>&1 | tee summary.log
          
          TOTAL_USERS=$(grep -oP 'æ€»äººæ•°: \K\d+' summary.log || echo "0")
          DATA_DAYS=$(grep -oP 'æ•°æ®å¤©æ•°: \K\d+' summary.log || echo "0")
          
          echo "total_users=$TOTAL_USERS" >> $GITHUB_OUTPUT
          echo "data_days=$DATA_DAYS" >> $GITHUB_OUTPUT
      
      - name: Setup Git
        if: steps.check.outputs.exists == 'false'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Commit monthly reports
        if: steps.check.outputs.exists == 'false'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ğŸ“Š Monthly summary: ${{ steps.month.outputs.month }}
          
          - æ±‡æ€»äººæ•°: ${{ steps.generate.outputs.total_users }} äºº
          - æ•°æ®å¤©æ•°: ${{ steps.generate.outputs.data_days }} å¤©
          - ç”Ÿæˆæ—¶é—´: $(date -u +%Y-%m-%d_%H:%M:%S)"
          file_pattern: 'monthly-reports/* data/*.json'
          commit_user_name: 'github-actions[bot]'
          commit_user_email: 'github-actions[bot]@users.noreply.github.com'
      
      - name: Create monthly issue
        if: steps.check.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const month = '${{ steps.month.outputs.month }}';
            const totalUsers = '${{ steps.generate.outputs.total_users }}';
            const dataDays = '${{ steps.generate.outputs.data_days }}';
            
            const title = `ğŸ“Š ${month} æœˆåº¦æ±‡æ€»æŠ¥å‘Š`;
            const body = `## ${month} æœˆåº¦å­¦ä¹ æ•°æ®æ±‡æ€»
            
            ### ç»Ÿè®¡æ¦‚è§ˆ
            - **æ±‡æ€»äººæ•°**: ${totalUsers} äºº
            - **æ•°æ®å¤©æ•°**: ${dataDays} å¤©
            - **ç”Ÿæˆæ—¶é—´**: ${new Date().toLocaleString('zh-CN')}
            
            ### æŸ¥çœ‹æŠ¥è¡¨
            - [æœˆåº¦æ±‡æ€»HTML](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/monthly-reports/${month}.html)
            - [æœˆåº¦æ±‡æ€»JSON](./monthly-reports/${month}.json)
            - [æœˆåº¦æ±‡æ€»CSV](./monthly-reports/${month}.csv)
            
            ### æ•°æ®æ–‡ä»¶
            - [æœˆåº¦æ•°æ®JSON](./data/${month}.json)
            
            ---
            *è‡ªåŠ¨ç”Ÿæˆçš„æœˆåº¦æ±‡æ€»æŠ¥å‘Š*`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['monthly-report', 'automated']
            });
